/*
 * Copyright (c) 2023-2025 Cypress Semiconductor Corporation (an Infineon company)
 * or an affiliate of Cypress Semiconductor Corporation. All rights reserved.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *
 */

#ifndef CONFIG_TFM_TARGET_H
#define CONFIG_TFM_TARGET_H

#ifdef IFX_PROJECT_CONFIG_PATH
/* Include project specific configuration header */
#include IFX_PROJECT_CONFIG_PATH
#endif

#if DOMAIN_S
/* Include header generated by cmake */
#include "ifx_spe_config.h"
#endif

/* Include platform customization */
#include "ifx_platform_config.h"

#ifdef IFX_BSP_CONFIG_HEADER_FILE
/* Include configuration provided by BSP */
#include IFX_BSP_CONFIG_HEADER_FILE
#endif

/* Use MPC memory configuration provided by Memory Configurator */
#define IFX_MEMORY_CONFIGURATOR_MPC_CONFIG

#ifndef ITS_BUF_SIZE
/*
 * Size of the ITS internal data transfer buffer
 * (Default to the max asset size so that all requests can be handled in one iteration.)
 * It should speed up SMIF operations and reduce number of erase cycles.
 */
#define ITS_BUF_SIZE                           ITS_MAX_ASSET_SIZE
#endif

#if defined(TFM_FIH_PROFILE_ON) && !defined(CONFIG_TFM_NS_AGENT_TZ_STACK_SIZE)
#define CONFIG_TFM_NS_AGENT_TZ_STACK_SIZE      0xC00
#endif

#if !defined CONFIG_TFM_USE_TRUSTZONE
#if !defined CONFIG_TFM_SPM_THREAD_STACK_SIZE
/* SPM has to have its own stack if Trustzone isn't present. */
#if defined(TFM_FIH_PROFILE_ON)
#define CONFIG_TFM_SPM_THREAD_STACK_SIZE       0x900
#endif /* defined(TFM_FIH_PROFILE_ON) */
#endif /* !defined CONFIG_TFM_SPM_THREAD_STACK_SIZE */
#endif /* !defined CONFIG_TFM_USE_TRUSTZONE */

/* The stack size of the Crypto Secure Partition */
#if CRYPTO_STACK_SIZE < 0x2000
#undef CRYPTO_STACK_SIZE
#define CRYPTO_STACK_SIZE                      0x2000
#endif

/* The stack size of the Protected Storage partition */
#ifndef PS_STACK_SIZE
#define PS_STACK_SIZE                      0x1000
#elif PS_STACK_SIZE < 0x1000
#warning "Protected Storage partition stack size PS_STACK_SIZE too small, increased to 0x1000"
#undef PS_STACK_SIZE
#define PS_STACK_SIZE                      0x1000
#endif

#ifndef PS_NUM_ASSETS
/* The maximum number of assets to be stored in the Protected Storage area. */
#define PS_NUM_ASSETS                           20
#endif

/* The Crypto buffer size */
#if TEST_NS_IFX_CRYPTO_BENCHMARK
#undef CRYPTO_IOVEC_BUFFER_SIZE
#define CRYPTO_IOVEC_BUFFER_SIZE               0x20000

#undef CRYPTO_ENGINE_BUF_SIZE
#define CRYPTO_ENGINE_BUF_SIZE                 0x3E800
#endif /* TEST_NS_IFX_CRYPTO_BENCHMARK */

/* Code coverage requires more stack */
#if TEST_NS_IFX_CODE_COVERAGE
/* The stack size of the SE IPC Partition */
#ifndef IFX_SE_IPC_SERVICE_STACK_SIZE
#define IFX_SE_IPC_SERVICE_STACK_SIZE          0x1000
#elif IFX_SE_IPC_SERVICE_STACK_SIZE < 0x1000
#warning "IFX SE IPC Service stack size IFX_SE_IPC_SERVICE_STACK_SIZE too small, increased to 0x1000"
#undef IFX_SE_IPC_SERVICE_STACK_SIZE
#define IFX_SE_IPC_SERVICE_STACK_SIZE          0x1000
#endif

/* The stack size of the TFM Platform Partition */
#ifndef PLATFORM_SP_STACK_SIZE
#define PLATFORM_SP_STACK_SIZE          0x1000
#elif PLATFORM_SP_STACK_SIZE < 0x1000
#warning "TFM Platform Service stack size PLATFORM_SP_STACK_SIZE too small, increased to 0x1000"
#undef PLATFORM_SP_STACK_SIZE
#define PLATFORM_SP_STACK_SIZE          0x1000
#endif

/* The stack size of the Attestation partition */
#ifndef ATTEST_STACK_SIZE
#define ATTEST_STACK_SIZE                      0x1000
#elif ATTEST_STACK_SIZE < 0x1000
#warning "Attestation partition stack size ATTEST_STACK_SIZE too small, increased to 0x1000"
#undef ATTEST_STACK_SIZE
#define ATTEST_STACK_SIZE                      0x1000
#endif
#else
#ifndef IFX_SE_IPC_SERVICE_STACK_SIZE
#define IFX_SE_IPC_SERVICE_STACK_SIZE          0x400
#elif IFX_SE_IPC_SERVICE_STACK_SIZE < 0x400
#warning "IFX SE IPC Service stack size IFX_SE_IPC_SERVICE_STACK_SIZE too small, increased to 0x0400"
#undef IFX_SE_IPC_SERVICE_STACK_SIZE
#define IFX_SE_IPC_SERVICE_STACK_SIZE          0x400
#endif
#endif

#if IFX_PRINT_CORE_PREFIX
#ifndef IFX_STDIO_S_PREFIX
/* Prefix used to separate message from secure CM33 code generated by stdio_output_string */
#define IFX_STDIO_S_PREFIX                      "$S33$"
#endif
#ifndef IFX_STDIO_NS_CM33_PREFIX
/* Prefix used to separate message from non-secure CM33 code generated by stdio_output_string */
#define IFX_STDIO_NS_CM33_PREFIX                "$N33$"
#endif
#ifndef IFX_STDIO_NS_CM55_PREFIX
/* Prefix used to separate message from non-secure CM55 code generated by stdio_output_string */
#define IFX_STDIO_NS_CM55_PREFIX                "$N55$"
#endif

#define IFX_STDIO_CORE_STR(core_id) \
        (((core_id) == IFX_STDIO_CORE_S33) ? IFX_STDIO_S_PREFIX : \
         ((core_id) == IFX_STDIO_CORE_N33) ? IFX_STDIO_NS_CM33_PREFIX : \
         ((core_id) == IFX_STDIO_CORE_N55) ? IFX_STDIO_NS_CM55_PREFIX : \
         "$?$")
#endif /* IFX_PRINT_CORE_PREFIX */

/* IFX_STDIO_CORE_ID defines core id for current image */
#if DOMAIN_S && (IFX_CORE == IFX_CM33)
#define IFX_STDIO_CORE_ID IFX_STDIO_CORE_S33
#elif DOMAIN_NS && (IFX_CORE == IFX_CM33)
#define IFX_STDIO_CORE_ID IFX_STDIO_CORE_N33
#elif DOMAIN_NS && (IFX_CORE == IFX_CM55)
#define IFX_STDIO_CORE_ID IFX_STDIO_CORE_N55
#endif

/* Core id of TF-M secure image */
#define IFX_STDIO_CORE_S_ID IFX_STDIO_CORE_S33

#define IFX_STDIO_CORE_COUNT                    3

#ifndef IFX_LINKER_SCRIPT
typedef enum
{
    IFX_STDIO_CORE_S33,  /* CM33 secure */
    IFX_STDIO_CORE_N33,  /* CM33 non-secure */
    IFX_STDIO_CORE_N55,  /* CM55 non-secure */
} ifx_stdio_core_id_t;
#endif /* IFX_LINKER_SCRIPT */

#ifdef IFX_TEST_SE_KEY_LOCATION
/* SE-RT does not support asymmetric key encryption */
#undef CRYPTO_ASYM_ENCRYPT_MODULE_ENABLED
#define CRYPTO_ASYM_ENCRYPT_MODULE_ENABLED 0
#endif

#if defined(IFX_MTB_SRF)
#define PLATFORM_ADDITIONAL_SERVICES    1
#define CONFIG_TFM_VECTOR_ACCESS        1
#endif

#if PLATFORM_SERVICE_INPUT_BUFFER_SIZE < 128
/* Platform service buffer size is increased to fit log message */
#undef PLATFORM_SERVICE_INPUT_BUFFER_SIZE
#define PLATFORM_SERVICE_INPUT_BUFFER_SIZE      128U
#endif

#ifndef LOG_PRIV_BUFFER_SIZE
/* Buffer size used by tfm_log.h API. */
#define LOG_PRIV_BUFFER_SIZE                    128U
#endif

#ifndef LOG_UNPRIV_BUFFER_SIZE
/* Buffer size used by tfm_log_unpriv.h API. */
#define LOG_UNPRIV_BUFFER_SIZE                  128U
#endif

#if IFX_CM55_NS_PRESENT
/* When CM55 NSPE is present - enable CONFIG_TFM_PSA_CALL_ADDRESS_REMAP to
 * support CM55 internal TCM memory */
#ifndef CONFIG_TFM_PSA_CALL_ADDRESS_REMAP
#define CONFIG_TFM_PSA_CALL_ADDRESS_REMAP       1
#endif /* CONFIG_TFM_PSA_CALL_ADDRESS_REMAP */
#endif /* IFX_CM55_NS_PRESENT */

/* Increase secure test partition size */
#define SECURE_TEST_PARTITION_STACK_SIZE        0x1200

#endif /* CONFIG_TFM_TARGET_H */
